#!/bin/bash

# Get the IPs currently on the bridge used for intercepting VMaaS traffic.
VF_BRIDGE_IPS=$(ip addr show dev pfdpu000br-dpu | grep -oP 'inet\s\K[\d.\/]+')

INCOMING_IPS=("10.10.10.2/29" "1.1.1.1/32")

# Find only the bridge IPs that need to be removed.
OLD_VF_BRIDGE_IPS=$(diff --old-line-format="%L" --unchanged-line-format="" --new-line-format="" \
    <(printf "%s\n" "${VF_BRIDGE_IPS[@]}" | sort) \
    <(printf "%s\n" "${INCOMING_IPS[@]}" | sort))


# Add the new internal routing IPs to the bridge if they need to be added.
if ! ip addr show pfdpu000br-dpu | grep 10.10.10.2/29; then
    ip addr add 10.10.10.2/29 dev pfdpu000br-dpu || exit $?
fi

if ! ip addr show pfdpu000br-dpu | grep 1.1.1.1/32; then
    ip link set pfdpu000br-dpu up
    ip addr add 1.1.1.1/32 dev pfdpu000br-dpu || exit $?
    # This is how Catalyst learns the current local GENEVE VTEP IP.
    ovs-vsctl set Open_vSwitch . external_ids:ovn-encap-ip=1.1.1.1 || exit $?
fi

# Now remove all the old IPs
# If something went wrong, we'll have exited and won't rip down the old IPs.
# The next cycle will put things in order if there are no errors.
for OLD_IP in "${OLD_VF_BRIDGE_IPS[@]}";do
    ip addr del $OLD_IP dev pfdpu000br-dpu || true
done;
