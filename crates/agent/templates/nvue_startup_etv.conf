{{- $nvueConfig := . -}}
- header:
    model: VX
    nvue-api-version: nvue_v1
    rev-id: 1.0
    version: Cumulus Linux 5.6.0
- set:
    bridge:
      domain:
        br_default:
          vlan:
{{- range .Tenant.PortConfigs }}
  {{- if .L2VNI }}
            '{{ .VlanID }}':
              vni:
                '{{ .L2VNI }}': {}
  {{- else }}
            '{{ .VlanID }}': {}
  {{- end }}
{{- end }}
    evpn:
      enable: on
    interface:
      lo:
        ip:
          address:
            {{ .LoopbackIP }}/32: {}
        type: loopback
{{- if .HbnVersion }}
  {{- if (ge .HbnVersion "1.5.0-doca2.2.0" )}}
    {{- if (ge .HbnVersion "2.3.0-doca2.8.0" )}}
      pf0dpu1_if:
    {{- else }}
      pf0dpu1_sf:
    {{- end }}
        ip:
          address:
            169.254.169.253/30: {}
  {{- end }}
  {{- if $nvueConfig.HasInternalBridgeRouting }}
    {{- if (ge .HbnVersion "1.5.0-doca2.2.0" )}}
      {{- if (ge .HbnVersion "2.3.0-doca2.8.0" )}}
      {{ $nvueConfig.VfInterceptBridgeSf }}_if:
      {{- else }}
      {{ $nvueConfig.VfInterceptBridgeSf }}_sf:
      {{- end }}
        ip:
          address:
            {{ $nvueConfig.VfInterceptHbnRepresentorIp }}/{{ $nvueConfig.InterceptBridgePrefixLen }}: {}
    {{- end }}
  {{- end }}
{{- end }}

{{- range .Uplinks}}
      {{ . }}:
        type: swp
{{- end }}

{{- $tenant := .Tenant }}
{{- range .Tenant.PortConfigs }}
      {{ .InterfaceName }}:
        type: swp
        bridge:
          domain:
            br_default:
              access: {{ .VlanID }}
  {{- if not $.UseAdminNetwork }}
        acl:
          {{- if $.HasDenyPrefixes }}
          p0000_deny_prefixes_ipv4:
            inbound: {}
          {{- end }}
          drop_dhcp_flood_over_overlay:
            inbound: {}
    {{- if $nvueConfig.HasIpv4EgressSecurityPolicyOverrideRules }}
          p0004_security_policy_override_ipv4_host_egress:          
            inbound: {}
    {{- end }}
    {{- if $nvueConfig.HasIpv6EgressSecurityPolicyOverrideRules }}
          p0004_security_policy_override_ipv6_host_egress:
            inbound: {}
    {{- end }}
    {{- if $nvueConfig.HasIpv4IngressSecurityPolicyOverrideRules }}
          p0004_security_policy_override_ipv4_host_ingress:
            outbound: {}
    {{- end }}
    {{- if $nvueConfig.HasIpv6IngressSecurityPolicyOverrideRules }}
          p0004_security_policy_override_ipv6_host_ingress:
            outbound: {}
    {{- end }}
    {{- if $tenant.HasNetworkSecurityGroup }}
          p0005_security_group_ipv4_in: 
            inbound: {}
          p0005_security_group_ipv6_in:
            inbound: {}
          p0005_security_group_ipv4_out: 
            outbound: {}
          p0005_security_group_ipv6_out: 
            outbound: {}
    {{- end }}
    {{- if $tenant.HasVpcPeerPrefixes }}
          p0009_vpc_peer_egress_from_host:
            inbound: {}
          p0009_vpc_peer_ingress_to_host:
            outbound: {}
    {{- end }}
    {{- if and ($.UseVpcIsolation) ($.HasSiteFabricPrefixes) }}
      {{- if not $tenant.HasNetworkSecurityGroup }}
          p0010_vpc_isolation_ipv4:
            inbound: {}
      {{- end }}
    {{- end }}
  {{- end }}
      vlan{{ .VlanID }}:
        type: svi
        vlan: {{ .VlanID }}
  {{- if gt (len .IPs) 0 }}
        ip:
          address:
          {{- range .IPs }}
            {{ . }}: {}
          {{- end }}
  {{- end }}
{{- end }}
    nve:
      vxlan:
        arp-nd-suppress: on
        enable: on
        source:
          address: {{ .LoopbackIP }}
    router:
      bgp:
        autonomous-system: {{ .ASN }}
        enable: on
        router-id: {{ .LoopbackIP }}
      policy:
        prefix-list:
          FORGE_FROM_UNDERLAY:
            rule:
              '10':
                action: permit
                match:
                  0.0.0.0/0: {}
              '1000':
                action: deny
                match:
                  any: {}
          dpu_from_instance:
            rule:
            {{- range $nvueConfig.AnycastSitePrefixes }}
              '{{ .Index }}':
                action: permit
                match:
                  {{ .Prefix }}:
                    min-prefix-len: 32
            {{- end }}
              '65535':
                action: deny
                match:
                  any: {}
        route-map:
          FORGE_TO_UNDERLAY:
            rule:
{{- range .Tenant.PortConfigs }}
              '{{ .Index }}':
                action:
                  deny: {}
                match:
                  interface: vlan{{ .VlanID }}
{{- end }}
              '1000':
                action:
                  permit: {}
          dpu_to_instance:
            rule:
              '10':
                action:
                  deny: {}
{{- if $nvueConfig.StatefulAclsEnabled }}
  {{- if .Tenant.HasNetworkSecurityGroup }}
    system:
      reflexive-acl:
        enable: on                  
  {{- end }}
{{- end }}
    vrf:
      default:
        router:
          nexthop-tracking:
            ipv4:
              resolved-via-default: on
          static:
          {{- if $nvueConfig.HasSecondaryOverlayVTEP }}
            {{ $nvueConfig.SecondaryOverlayVtepIP }}/32:
              address-family: ipv4-unicast
              via:
                {{ $nvueConfig.VfInterceptBridgeIP }}:
                  type: ipv4-address
          {{- end }}          
{{- range .Tenant.HostInterfaces }}
            {{ .HostRoute }}:
              address-family: ipv4-unicast
              via:
                vlan{{ .ID }}:
                  type: interface
{{- end }}
          bgp:
            address-family:
              ipv4-unicast:
                network:
                {{- if $nvueConfig.HasSecondaryOverlayVTEP }}
                  {{ $nvueConfig.SecondaryOverlayVtepIP }}/32: {}
                {{- end }}
                  {{ .LoopbackIP }}/32: {}
{{- range .Tenant.HostInterfaces }}
                  {{ .HostRoute }}: {}
{{- end }}
                enable: on
                multipaths:
                  ebgp: 128
                redistribute:
                  connected:
                    enable: on
              l2vpn-evpn:
                enable: on
            enable: on
            neighbor:
{{- range .RouteServers }}
              {{ . }}:
                peer-group: routeserver
                type: numbered
{{- end }}
{{- range .Uplinks}}
              {{ . }}:
                peer-group: underlay
                type: unnumbered
{{- end }}
{{- if not .UseAdminNetwork }}
  {{- range .Tenant.HostInterfaces}}
    {{- if .HostIP }}
              {{ .HostIP }}:
                passive-mode: on
                peer-group: tenant
                type: numbered
    {{- end }}
  {{- end }}
{{- end }}
{{- if $nvueConfig.PublicPrefixInternalNextHop }}
              {{ $nvueConfig.PublicPrefixInternalNextHop }}:
                passive-mode: on
                peer-group: tenant
                type: numbered
{{- end }}
            path-selection:
              multipath:
                aspath-ignore: on
            peer-group:
              routeserver:
                address-family:
                  ipv4-unicast:
                    enable: off
                  l2vpn-evpn:
                    aspath:
                      allow-my-asn:
                        enable: on
                    enable: on
                multihop-ttl: 255
                remote-as: external
                update-source: lo
{{- if not .UseAdminNetwork }}
              tenant:
                address-family:
                  ipv4-unicast:
                    policy:
                      inbound:
                        prefix-list: dpu_from_instance
                      outbound:
                        route-map: dpu_to_instance
                nexthop-connected-check: off
                {{- if $nvueConfig.Tenant.HasHostASN }}
                remote-as: {{ $nvueConfig.Tenant.HostASN }}
                {{- else }}
                remote-as: external
                {{- end }}
                timers:
                  connection-retry: 10
                  hold: 9
                  keepalive: 3
                  route-advertisement: none
{{- end }}
              underlay:
                remote-as: external
                address-family:
                  ipv4-unicast:
                    policy:
                      inbound:
                        prefix-list: FORGE_FROM_UNDERLAY
                      outbound:
                        route-map: FORGE_TO_UNDERLAY
                    aspath:
                      allow-my-asn:
                        enable: on
{{- if eq (len .RouteServers) 0 }}
                  l2vpn-evpn:
                    aspath:
                      allow-my-asn:
                        enable: on
                    enable: on
{{- end }}
{{- if not .UseAdminNetwork }}
    acl:
{{- $tenant := .Tenant }}
{{- if $nvueConfig.HasDenyPrefixes }}
      p0000_deny_prefixes_ipv4:
        type: ipv4
        rule:
  {{- if not $tenant.HasNetworkSecurityGroup }}
      {{- range .Tenant.PortConfigs }}
        {{- range .VpcPrefixes }}
          '{{ .Index }}':
            action:
              permit: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
        {{- end }}
      {{- end }}
  {{- end }}

  {{- range $nvueConfig.DenyPrefixes }}
          '{{ .Index }}':
            action:
              deny: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
  {{- end }}
{{- end }}

{{- if and ($nvueConfig.UseVpcIsolation) ($nvueConfig.HasSiteFabricPrefixes) }}
    {{- if not .Tenant.HasNetworkSecurityGroup }}
      p0010_vpc_isolation_ipv4:
        type: ipv4
        rule:
      {{- range .Tenant.PortConfigs }}
        {{- range .VpcPrefixes }}
          '{{ .Index }}':
            action:
              permit: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
        {{- end }}
      {{- end }}
      {{- range $nvueConfig.SiteFabricPrefixes }}
          '{{ .Index }}':
            action:
              deny: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
      {{- end }}
    {{- end }}
{{- end }}
 
{{- if .Tenant.HasNetworkSecurityGroup }}
      p0005_security_group_ipv4_in: {{/* Ingress and Egress is defined from instance perspective, so reverse on DPU side */}}
        rule:
      {{- if .Tenant.HasIpv4EgressSecurityGroupRules }}
        {{- range .Tenant.EgressNetworkSecurityGroupRulesIpv4 }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              {{- if and ($nvueConfig.StatefulAclsEnabled) (.CanBeStateful) }}
              conntrack:
                new: {}
                established: {}
              {{- end }}
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }} 
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end}}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
          '65535':
            action:
              {{- if .Tenant.HasNetworkSecurityGroup }}
              deny: {}
              {{- else }}
              permit: {}
              {{- end }}
        type: ipv4
      p0005_security_group_ipv6_in: {{/* Ingress and Egress is defined from instance perspective, so reverse on DPU side */}}
        rule:
      {{- if .Tenant.HasIpv6EgressSecurityGroupRules }}
        {{- range .Tenant.EgressNetworkSecurityGroupRulesIpv6 }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }} 
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end }}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
          '65535':
            action:
              {{- if .Tenant.HasNetworkSecurityGroup }}
              deny: {}
              {{- else }}
              permit: {}
              {{- end }}
        type: ipv6
      p0005_security_group_ipv4_out: {{/* Ingress and Egress is defined from instance perspective, so reverse on DPU side */}}
        rule:
      {{- if .Tenant.HasIpv4IngressSecurityGroupRules }}
        {{- range .Tenant.IngressNetworkSecurityGroupRulesIpv4 }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }}
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end }}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
      {{- if $nvueConfig.StatefulAclsEnabled }}
          '65532':
            action:
              permit: {}
            match:
              ip:
                protocol: tcp
              conntrack:
                established: {}
          '65533':
            action:
              permit: {}
            match:
              ip:
                protocol: udp
              conntrack:
                established: {}
          '65534':
            action:
              permit: {}
            match:
              ip:
                protocol: icmp
              conntrack:
                established: {}
      {{- end }}
          '65535':
            action:
              {{- if .Tenant.HasNetworkSecurityGroup }}
              deny: {}
              {{- else }}
              permit: {}
              {{- end }}
        type: ipv4
      p0005_security_group_ipv6_out: {{/* Ingress and Egress is defined from instance perspective, so reverse on DPU side */}}
        type: ipv6
        rule:
      {{- if .Tenant.HasIpv6IngressSecurityGroupRules }}
        {{- range .Tenant.IngressNetworkSecurityGroupRulesIpv6 }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }} 
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end}}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
          '65535':
            action:
              {{- if .Tenant.HasNetworkSecurityGroup }}
              deny: {}
              {{- else }}
              permit: {}
              {{- end }}
{{- end }}

{{- if .Tenant.HasVpcPeerPrefixes }}
      p0009_vpc_peer_egress_from_host:
        type: ipv4
        rule:
        {{- range .Tenant.VpcPeerPrefixes }}
          '{{ .Index }}':
            action:
              permit: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
        {{- end }}
      p0009_vpc_peer_ingress_to_host:
        type: ipv4
        rule:
        {{- range .Tenant.VpcPeerPrefixes }}
          '{{ .Index }}':
            action:
              permit: {}
            match:
              ip:
                source-ip: {{ .Prefix }}
        {{- end }}
{{- end }}
      drop_dhcp_flood_over_overlay:
        rule:
          '10':
            action:
              deny: {}
            hw-offload: off
            match:
              ip:
                dest-ip: 255.255.255.255
                protocol: udp
                dest-port:
                  '67': {}
                source-port:
                  '68': {}
        type: ipv4
{{- end }}
{{- if not $.UseAdminNetwork }}
     {{- if $nvueConfig.HasIpv4EgressSecurityPolicyOverrideRules }}
      p0004_security_policy_override_ipv4_host_egress:
        type: ipv4
        rule:
        {{- range $nvueConfig.Ipv4EgressNetworkSecurityPolicyOverrideRules }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }} 
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end}}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
      {{- if $nvueConfig.HasIpv6EgressSecurityPolicyOverrideRules }}
      p0004_security_policy_override_ipv6_host_egress:
        type: ipv6
        rule:
        {{- range $nvueConfig.Ipv6EgressNetworkSecurityPolicyOverrideRules }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }} 
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end }}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
      {{- if $nvueConfig.HasIpv4IngressSecurityPolicyOverrideRules }}
      p0004_security_policy_override_ipv4_host_ingress:
        type: ipv4
        rule:
        {{- range $nvueConfig.Ipv4IngressNetworkSecurityPolicyOverrideRules }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }}
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end }}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
      {{- if $nvueConfig.HasIpv6IngressSecurityPolicyOverrideRules }}
      p0004_security_policy_override_ipv6_host_ingress:
        type: ipv6
        rule:
        {{- range $nvueConfig.Ipv6IngressNetworkSecurityPolicyOverrideRules }}
          '{{ .Priority }}':
            action:
              {{ .Action }}: {}
            match:
              ip:
                dest-ip: {{ .DstPrefix }}
                {{- if .HasDstPort }}
                dest-port:
                  '{{ .DstPort }}': {}
                {{- end }} 
                {{- if not .CanMatchAnyProtocol }} 
                protocol: {{ .Protocol }}
                {{- end}}
                source-ip: {{ .SrcPrefix }} 
                {{- if .HasSrcPort }}
                source-port:
                  '{{ .SrcPort }}': {}
                {{- end }} 
        {{- end }}
      {{- end }}
{{- end }}
